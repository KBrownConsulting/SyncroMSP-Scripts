<###########################################
ScreenConnect 23.9.8 Vulnerability Check
Author:         Karl Brown
Version:        1.1
Release Date:   2024-02-21
URL:            https://github.com/KBrownConsulting/SyncroMSP-Scripts/blob/main/ScreenConnect_Vulnerability_Check_v23.9.8.ps1
############################################

Changelog:
============================================
    1.0 - Initial Release
    1.1 - Added more info to the Potential Issues / False Positives notes. No code changes. 

Description:
============================================
This script will search for vulnerable ScreenConnect processes running on a machine related to the critical
ScreenConnect vulnerability announced by ConnectWise on 2024-02-19:

https://www.connectwise.com/company/trust/security-bulletins/connectwise-screenconnect-23.9.8
https://www.huntress.com/blog/a-catastrophe-for-control-understanding-the-screenconnect-authentication-bypass

If a vulnerable version is detected it will output info about the process including: process name, file path,
ScreenConnect version, and even try to detect and report the host and port of the associated ScreenConnect server!

It will also trigger a Syncro alert if the script detects it has been run from Syncro. 

Note: Version 23.9.8 is the version where the vulnerability was patched so we want to check and make sure all
      processes are running at least that version or newer. 

Requirements
============================================
 - I believe the script should run as is on nearly any powershell enabled Windows machine. 
 - Tested on Windows 10 & 11 with PowerShell 5. 
 - Works as is with or without Syncro. (Intilligently detects if launched by Syncro & only generates Syncro
   alerts if launched by Syncro.)


 
Potential Issues / False Positives
============================================
Because ScreenConnect makes it so easy to customize the name of the application, searching based on file or
process name is not reliable.  As a result this script simply checks the version number of any running process
that is signed by ConnectWise. (It also checks for processes signed by ScreenConnect to catch really old versions.) 

Due to this strategy, there is a good chance that if there are other non ScreenConnect ConnectWise processes
running on the system, the script may incorrectly flag them as potentially vulnerable processes. 

Since I don't use any other ConnectWise software except ScreenConnect I have no easy way to test for this. The
information ouput should make it easy (I hope) to identify any false positives though. 

Note:
Simply having an old version of the ScreenConnect agent running on a system does NOT actually mean that the
computer is vulnerable. The vulnerability is not in the client software but rather in the ScreenConnect server.

The vulnerability allows attackers to take over a ScreenConnect server which then makes any machines the
ScreenConnect server can control vulnerable to compromise. It is totally possible to have a PC running an old
version of the ScreenConnect client software while the server is up to date. As long as the server has been
patched to run version 23.9.8 or newer, it is no longer at risk of being compromised by this vulnerability
so all clients managed by that server are safe by extension regardless of which version they are running.

So, if the client version makes no difference, then why bother checking it? Because ScreenConnect has an option
to automatically update client agents after an update is applied to the server, and in my experience most
ScreenConnect admins try to keep the client version in line with the server. But more importantly, due to the
nature of how ScreenConnect works, it is almost impossible to have the client running a newer version of the
software than is running on the server. So while not 100% guaranteed, it's probably safe to assume that if the
client is running 23.9.8, then the server almost certainly is as well. (The only exception is if the server was
updated to 23.9.8, the new agent version pushed out to clients, and then subsequently the ScreenConnect server
was downgraded for some reason. Hopefully a very unlikely ocurrance, especially under the current circumstances.)

############################################>

if ($null -ne $env:SyncroModule) { 
    Import-Module $env:SyncroModule -DisableNameChecking
    $syncroPC = $true
}

$safeVersion = [version]"23.9.8"
$signers = @("ConnectWise", "ScreenConnect", "Elsinore")
$found = ""
Get-Process | Where-Object { $_.Path -ne $null } | ForEach-Object {
  $signature = Get-AuthenticodeSignature -FilePath $_.Path
  if ($signature) {
    $cn = ""
    $match = $signature.SignerCertificate.Subject | Select-String -Pattern 'CN=([^,]+)|CN="([^"]+)"'
    if ($match) {
        if ($match.Matches.Groups[1].Success) {
            $cn = $match.Matches.Groups[1].Value.Trim()
        } elseif ($match.Matches.Groups[2].Success) {
            $cn = $match.Matches.Groups[2].Value.Trim('"')
        }
    }
    foreach ($signer in $signers) {
        if ($cn -like "*$signer*") {
          $fileVersion = (Get-Item $_.Path).VersionInfo.FileVersion
          if ([version]$fileVersion -lt $safeVersion) {
            $processNameWithExtension = $_.ProcessName + [System.IO.Path]::GetExtension($_.Path)
            $commandLine = (Get-CimInstance Win32_Process -Filter "ProcessId=$($_.Id)" | Select-Object CommandLine)
            $pattern = 'h=([^&]+)'
            if ($commandLine -match $pattern) {
                $server = $matches[1]
            }
            $pattern = 'p=([^&]+)'
            if ($commandLine -match $pattern) {
                $port = $matches[1]
            }
            $found += "Process: $processNameWithExtension`n Path: $($_.Path)`n Version: $fileVersion`n Server: $server`:$port `n`n"
          }
        }
    }
  }
}

if ($found) {
    $message = "WARNING: Potentially vulnerable ScreenConnect processes older than $safeVersion found! Please review!`n`n"
    $message += $found
    Write-Host $message
    if ($syncroPC) {
        Rmm-Alert -Category "ScreenConnect Vulnerability 23.9.8" -Body $message
    }
} else {
    Write-Host "No vulnerable versions of ScreenConnect detected running!"
}
